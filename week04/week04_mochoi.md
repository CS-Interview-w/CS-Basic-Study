# 인증과 인가

## 원준님이 보내주셨던 주제

### Cookie, Session, Token의 차이 ( 기본 )

#### Http Cookie 란?
- HTTP 쿠키란 웬 쿠키, 브라우저 쿠키로도 불리는데 서버가 사용자의 웹 브라우저에 전송하는 작은 데이터 조각을 의미한다.
- 유닉스의 매직쿠키에서 이름과 개념이 유래하였고, 루 몬텔루라는 웹 브라우저 개발자가 웹 사이트에 접속한 클라이언트를 확인하기 위해 만들었다
- HTTP 통신은 stateless 하기 때문에 클라이언트를 확인하기 위해서는 쿠키라는 개념이 따로 필요했기 때문이다.

#### Http Cookie 작동 방식
- 쿠키도 결국 HTTP 통신에서 이루어지는 것이기 때문에 HTTP 의 응답과 요청에 따라 작동한다.
- 요청을 받은 서버에서 쿠키를 클라이언트(웹 브라우저)로 보내고 클라이언트는 쿠키를 받으면 도메인 서버 이름으로 정렬된 쿠키 디렉토리에 쿠키(정보)를 저장한다
- 이후 클라이언트가 동일한 서버로 HTTP 요청을 보내면 저장된 쿠키도 같이 전송되며, 만약 서버에서 쿠키에 업데이트된 내용이 있으면 응답할 때 다시 업데이트된 쿠키를 보내준다.

##### HTTP의 stateless 란
- 상태가 없다는 뜻
-  HTTP에서 stateless 하다는건 서버 입장에서 클라이언트의 상태가 없다는 의미로 동일한 클라이언트의 요청이라도 매번 각 요청은 독립적이라는 의미이다.
- (서버)에서 손님이 입장(요청)했다가 퇴장(응답)했을 때 손님들을 한명 한명 다 기억할수가 없다. 그렇기 떄문에 놀이공원에서는 재입장하는 손님을 구분하기 위해 팔찌같은 입장권을 준다. 마찬가지로 서버에서도 이미 요청을 했었던 클라이언트인지 매번 확인하기 어렵기 때문에 입장권처럼 쿠키를 주는 것이다.
- 쿠키는 한개에 4KB 까지 저장 가능하며, 최대 300개 까지 저장할 수 있는 텍스트 파일이다.
- 쿠키는 클라이언트에 저장된다.
- 쿠키에는 이름, 값, 만료날짜, 경로 정보가 들어있다.
- 기본적으로 쿠키는 웹 브라우저가 종료되면 삭제된다. ( 만료날짜를 지정해 주면 만료일이 되야 삭제된다.)
- 웹 브라우저에 해당 서버의 쿠키 정보가 있으면 HTTP 요청 (HTTP 헤더의 Cookie)에 무조건 담아 보낸다.

#### Http Session 란?
- 통신을 하기 위해 서로 연결된 순간부터 통신을 마칠 때 까지의 기간
- HTTP 세션이란 클라이이언트가 웹서버에 연결된 순간부터 웹 브라우저를 닫아 서버와의 HTTP 통신을 끝낼 때 까지의 기간이다.
- 하지만 보통 세션이라고 말할 때에는 서버에 세션에 대한 정보(세션 상태, 클라이언트 상태, 세션 데이터 등)를 저장해 놓고 세션 쿠키( 고유한 세션 ID 값 )를 클라이언트에게 주어 서버가 클라이언트를 식별할 수 있도록 하는 방식자체를 의미하는 경우가 많다.
- 따로 용량의 제한이 없다. ( 서버의 능력에 따라 다를 수 있다. )
- 서버에 세션 객체를 생성하며 각 클라이언트 마다 고유한 세션 ID 값을 부여한다.
- 쿠키를 사용하여 세션 ID 값을 클라이언트에 보낸다.
- 웹 브라우저가 종료되면 세션 쿠키는 삭제된다.

#### Http Session 작동 방식
- 세션의 작동방식을 보면 우선 클라이언트가 서버에 요청을 보내면 서버에서는 요청헤더( Cookie )를 확인하고 세션 ID가 있는지 확인한다.
- 만약 요청에 세션 ID가 없다면 서버에서는 세션 ID를 생성한 뒤 응답을 보낼 때 쿠키에 세션 ID를 담아 보낸다. (서버에서는 이때 가장 먼저 세션 객체를 생성하여 정보를 저장한다.)
- 클라이언트는 응답에서 받은 세션 쿠키(세션 ID 값)를 저장해두고, 매번 해당 서버에 요청을 보낼 때마다 세션 쿠키를 함께 보내서 자신이 누구인지 인증한다. 세션 쿠키는 브라우저가 종료되면 삭제된다.

#### 쿠키와 세션의 관계
- 흔히 쿠키와 세션을 비교할 때 쿠키는 클라이언트(웹 브라우저)에 정보를 저장하는 것이고, 세션은 서버에 정보를 저장하는 것이다
- 쿠키는 stateless 한 HTTP 통신에서 클라이언트에게 정보(표시)를 주어 해당 클라이언트를 식별하기 위해 만들어졌다.
- 하지만 클라이언트에 저장된다는 쿠키의 특징은 보안에 있어서는 치명적인 단점이다.
- 예를들어 로그인을 위해 사용자가 입력한 아이디와 비밀번호를 쿠키에 담아 클라이언트에 저장한 뒤 서버에서는 쿠키로 해당 사용자가 로그인한 사용자인지 확인한다고 생각해보자. 그러면 누군가 마음만 먹으면 쿠키를 확인해 클라이언트에 저장된 아이디와 비밀번호를 볼 수 있다.
- 그래서 세션이라는 개념을 통해 중요한 정보는 서버에서 관리하고 클라이언트에게는 세션 쿠키( 세션 ID )를 주어 식별이 가능하도록 한 것이다. 


#### Token 란?
- 클라이언트에서 인증 정보를 보관하는 방법이다.
세션 기반 인증은 클라이언트에서 유저 정보를 요청 할 때마다 해당 정보를 줘도 되는지에 대해 세션 값 일치여부를 확인했었다. 매 요청마다 DB를 살펴보는 것이 불편하고, 부담이 되었기 때문에 토큰 기반 인증 개념이 생겨났다.
- 비록 클라이언트에 저장해서 보안에 취약할 수 있다고 생각이 들지만 토큰은 유저 정보를 암호화 한 상태로 담을 수 있고, 암호화했기 때문에 클라이언트에 담을 수 있다

토큰에는 여러 종류가 있다. 그 중에서 개방형이고 웹에서 널리 쓰이는 JWT에 대해서 알아보겠다.

#### JWT 란?
- Json Wep Token 의 약자
- 종류는 access token, refresh token 2가지
- Access Token & refresh token
- Access Token은 보호된 정보들에 접근할 수 있는 권한부여에 사용된다. 즉, 클라이언트가 처음 인증을 받게 될 때 (로그인), access token, refresh token 둘다 받게 되지만 실제로 권한을 얻는데 사용하는 토큰은 access token 이다.
- 권한을 부여받는 데엔 access token만 있으면 된다. 하지만 해커에 의해 토큰이 탈취된다면,로그인을 해서 여러 나쁜 행위들을 할 수 있다. (계좌 로그인이라면 피해자의 돈이 사라질 수 도 있겠다.)
그래서 access token의 만료기간을 짧게 주고 오랫동안 사용할 수 없도록 한다.
- access token이 만료될 때마다 refresh token을 통해 말 그래도 access token을 refresh 한다.
- 그래서 access token은 로그인 정보에 접근할 수 있는 카드키, refresh token은 카드키 재발급이라고 생각하면 기억하기 편할 것이다.
- 유저의 편의보다 정보로 지키는 것이 더 중요한 웹사이트들은 refresh token을 사용하지 않는 곳도 있다. 그러면 유저는 일정주기 마다 새로 로그인을 해야 할 것이다.
정부사이트는 로그인 제한시간 60분 이렇게 되어있으니까.

#### 인증과 인가
- 세션기반 인가와 토큰기반 인가에 대해 알아보기 이전에 먼저, 인증과 인가가 무엇인지 부터 알아야할 필요가 있다. 인증과 인가를 같거나 비슷한 개념이라고 생각하는 사람들이 많을텐데, 엄밀하게는 서로 다른 개념이다. 인증과 인가는 요약하자면 시스템의 자원을 적절하고 유효한 사용자에게 전달하고 공개하는 방법이다.


### Spring Security와 OAuth2 구글로그인의 흐름 ( 이건 욕심이 있으시면 )

## 참고 URL 과 참고 파트
- Http Cookie 란? & Http Cookie 작동 방식& Http Session 란? & Http Session 작동 방식 & 쿠키와 세션의 관계: https://noahlogs.tistory.com/38
- Token 란? & JWT 란? : https://velog.io/@boo1996/Token
- 인증과 인가 : https://hudi.blog/session-based-auth-vs-token-based-auth/

## 참고문헌
- 없음

## 원준님이 가르쳐준 내용(이미지 교체 필요)
#### ![photo_2024-09-01_14-07-20](https://github.com/user-attachments/assets/918a6c80-23b4-41dc-96fe-f7bd04d0ac1c)
#### 내용(단, 그 당시 들었던 내용을 간략하게 요약하여 내용을 기억에 남는 부분만 재구성하였으므로 들은 내용과 일치하지 않을 수 있습니다.)
- HTTP 는 비 연결성으로 상태가 없다. 즉, 단기 기억이 안좋다고 볼 수 있다. 그래서 예를 들어 옷가게에서 주문을 하려고 하면 20대 중후반 남자 옷을 찾는다고 정보를 보내줘야 데이터가 온다. 이런 식으로 요청을 보낼 때마다 파라미터로 여러 개 보내줄 수 있다. 하지만 만약 로그인 정보같은 경우에는 파라미터로 계속 정보를 보내줄 수 없다. 불편한 것은 둘째치고 보안상도 좋지 않다.
- 그래서 어떻게 저장할까 하다가 고안된 것이 쿠키이다. 보통 key와 value로 이루어져있는데 클라이언트는 이 key-value에서 key만 가지고 value 는 서버한테 있다. 그래서 이 클라이언트가 key를 가지고 정보 조회를 요청하면 value는 그 key 값을 가지고 value 와 매칭하여 내용을 조회할 수 있다.
- 보통은 민감하지 않은 정보와 같은 경우도 쿠키로 저장되어있는데, 이 경우에는 민감하지 않은 정보들을 저장하며 굳이 서버에 저장하지 않는다. 그 이유는 민감하지 않은 정보이기도 하고, 서버에 저장하면 서버가 무거워져서 힘들기 때문이다.
- 쿠키로 사용자의 정보를 트래킹하여 추천 알고리즘을 이용해주기도 한다.
- 사실 이런 식으로 애초에 유저 정보를 쿠키로 다 넘겨주면 다 세션으로 하지 않고 쿠키로 할 수 있는데 왜 그렇게 하지 않을까? 사실 그렇게 하면 보안 상 굉장히 나쁜 서비스가 된다.
- 클라이언트에 저장된다는 것 자체가 js 를 총해 쿠키를 열람할 수 있기 때문이다. 
- 다른 사이트에서 정적인 파일 js 같은 파일을 받으면 쿠키를 조회해서 그 쿠키 정보를 피싱사이트로 보내버릴 수 있다. 간단하게 ajax 드으로 볼수 있다.
- 물론 쿠키에도 보안 옵션이 있지만, 볼 수 있다는 것 자체도 문제가 된다.
- 그래서 장바구니같은 정보는 되지만 로그인 정보같은 경우에는 위와 같이 쿠키에 모든 정보를 저장해서는 안된다.
- (정리중...)
